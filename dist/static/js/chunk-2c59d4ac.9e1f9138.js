(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2c59d4ac"],{"0d8d":function(t,e,i){"use strict";var n=i("21b2"),s=i.n(n);s.a},"21b2":function(t,e,i){},"53f4":function(t,e,i){"use strict";i.r(e);var n=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{attrs:{id:"plan"},on:{mousemove:function(e){return t.drapMove(e)}}},[i("el-row",[i("el-col",{attrs:{span:24}},[i("div",{staticClass:"pan-box"},[i("div",{staticClass:"pan-name"},[t._v("查询条件")]),t._v(" "),i("div",{staticClass:"pan-form"},[i("el-form",{staticClass:"demo-form-inline",attrs:{inline:!0,"label-width":"80px"}},[i("el-autocomplete",{staticStyle:{width:"220px"},attrs:{"fetch-suggestions":t.querySearchAsync,placeholder:"请输入内容",disabled:t.isAdd},on:{select:t.handleSelect},model:{value:t.searchInfo.film_name,callback:function(e){t.$set(t.searchInfo,"film_name",e)},expression:"searchInfo.film_name"}}),t._v(" "),i("el-form-item",{attrs:{label:"选择语言"}},[i("el-select",{attrs:{disabled:t.isAdd},model:{value:t.searchInfo.language,callback:function(e){t.$set(t.searchInfo,"language",e)},expression:"searchInfo.language"}},t._l(t.searchInfo.languageArr,function(t,e){return i("el-option",{key:e,attrs:{label:t,value:t}})}),1)],1),t._v(" "),i("el-form-item",{attrs:{label:"选择版本"}},[i("el-select",{attrs:{disabled:t.isAdd},model:{value:t.searchInfo.film_version,callback:function(e){t.$set(t.searchInfo,"film_version",e)},expression:"searchInfo.film_version"}},t._l(t.searchInfo.film_versionArr,function(t,e){return i("el-option",{key:e,attrs:{label:t,value:t}})}),1)],1),t._v(" "),i("el-form-item",{attrs:{label:"影片价格"}},[i("el-input",{staticStyle:{width:"100px"},attrs:{disabled:t.isAdd},model:{value:t.searchInfo.sell_price,callback:function(e){t.$set(t.searchInfo,"sell_price",e)},expression:"searchInfo.sell_price"}})],1),t._v(" "),i("el-form-item",[i("el-button",{attrs:{type:"primary"},on:{click:t.addFilm}},[t._v(t._s(t.isAdd?"取消添加":"添加影片"))])],1)],1)],1)])])],1),t._v(" "),i("div",{directives:[{name:"loading",rawName:"v-loading",value:t.listLoading,expression:"listLoading"}],staticClass:"content-box",attrs:{"element-loading-text":"Loading"}},[i("div",{staticClass:"time-box"},[i("div",{staticClass:"select-date"},[i("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"date",placeholder:"选择日期","value-format":"yyyy-MM-dd"},on:{change:t.getSelectData},model:{value:t.nowDate,callback:function(e){t.nowDate=e},expression:"nowDate"}})],1),t._v(" "),i("div",{staticClass:"time-line"},[i("ul",t._l(t.effectiveTimeLong,function(e,n){return i("li",{key:n},[t._v(t._s(e)+":00")])}),0)])]),t._v(" "),i("div",{ref:"screenbox",staticClass:"screen-box"},[t._l(t.screenList,function(e,n){return i("div",{key:n,staticClass:"screen-bar clearfix"},[i("div",{staticClass:"screen-name"},[t._v(t._s(e.screen_name))]),t._v(" "),i("div",{ref:"lines",refInFor:!0,staticClass:"lines",attrs:{"data-screenid":e._id}},[i("ul",{staticClass:"time-item clearfix"},t._l(2*t.effectiveTimeLong.length,function(t,e){return i("li",{key:e})}),0),t._v(" "),i("div",{staticClass:"time-progress"}),t._v(" "),t._l(e.children,function(e,s){return i("div",{key:"a"+s,staticClass:"drag-film",class:"flimStatus"+e.status,style:{left:e._start_time+"px",width:e.film_long+"px"},attrs:{id:e._id},on:{contextmenu:function(e){return e.stopPropagation(),t.setRightClick(e,n,s)},click:function(i){return i.stopPropagation(),t.tapSelect(e.screen_id,e._id,e.status)}}},[i("dl",{staticClass:"drag-film-content"},[i("dt",[t._v(t._s(e.film_name))]),t._v(" "),i("dd",[t._v(t._s(t._f("getHm")(e.start_datetime))+"-"+t._s(t._f("getHm")(e.end_datetime)))]),t._v(" "),i("dd",[t._v(t._s(e.film_version)+" "+t._s(e.language))]),t._v(" "),i("dd",[t._v(t._s(e.sell_price)+"元")])]),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:e._isSetShow,expression:"item._isSetShow"}],staticClass:"setbox"},[i("p",{on:{click:function(i){return i.stopPropagation(),t.delPlan(e.screen_id,e._id)}}},[t._v("删除")])])])})],2)])}),t._v(" "),i("div",{ref:"drag",staticClass:"drag-film flimStatus0",style:{left:t.filmPos.pointXCenter+"px",top:t.filmPos.pointYCenter+"px",width:t.dragFilm.film_long+"px"},on:{click:t.downFilm}},[i("dl",{staticClass:"drag-film-content"},[i("dt",[t._v(t._s(t.dragFilm.film_name))]),t._v(" "),i("dd",[t._v(t._s(t.dragFilm.start_time)+"-"+t._s(t.dragFilm.end_time))]),t._v(" "),i("dd",[t._v(t._s(t.dragFilm.film_version)+" "+t._s(t.dragFilm.language))]),t._v(" "),i("dd",[t._v(t._s(t.dragFilm.sell_price)+"元")])])]),t._v(" "),i("div",{staticClass:"mark-line",style:{left:t.filmPos.pointXCenter+"px",top:0,height:81*t.filmPos.pointYCenter+"px"}})],2)]),t._v(" "),i("div",{staticClass:"plan-page-btns"},[i("goBack"),t._v(" "),0!=t.saveFilm.length?i("el-button",{attrs:{type:"warning",size:"medium"},on:{click:t.agree}},[t._v("审核影片")]):t._e()],1)],1)},s=[],a=(i("34a3"),i("e20c")),r=(i("f763"),i("7bc1"),i("4453"),i("089b")),c=i("b775");function o(t){return Object(c["a"])({url:"/api/searchFilm",method:"post",data:t})}function l(t){return Object(c["a"])({url:"/api/addSession",method:"post",data:t})}function d(t){return Object(c["a"])({url:"/api/getScreenSession",method:"get",params:t})}function m(t){return Object(c["a"])({url:"/api/delSession",method:"post",data:t})}function f(t){return Object(c["a"])({url:"/api/agreeSession",method:"post",data:t})}var h=i("ed08"),u=i("a3ba"),g={components:{goBack:u["a"]},data:function(){return{listLoading:!0,effectiveTimeLong:[],filmPos:{},nowDate:new Date,initConfig:{startPoint:6,endPoint:23,screenNameW:170,startPointStamp:""},dragFilm:{},defaultStopTime:0,searchInfo:{film_name:"",language:"",languageArr:[],film_version:"",film_versionArr:[],sell_price:""},isAdd:!1,saveFilm:[],screenList:[],cinema_id:null,agreeFilm:[]}},mounted:function(){this.cinema_id=this.$route.query.cinema_id,this.initConfig.startPointStamp=Object(h["c"])("".concat(Object(h["b"])(this.nowDate,"YMD")," ").concat(this.initConfig.startPoint,":0:0"))/1e3,this.initTable(this.initConfig),this.getScreenList()},computed:{},methods:{initTable:function(t){for(var e=t.startPoint,i=t.endPoint,n=e;n<=i;n++)this.effectiveTimeLong.push(n);this.defaultStopTime=3600*this.initConfig.startPoint},getScreenList:function(){var t=Object(r["a"])(regeneratorRuntime.mark(function t(){var e=this;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:this.listLoading=!0,d({cinema_id:this.cinema_id,selectDate:"".concat(Object(h["b"])(this.nowDate,"YMD"))}).then(function(t){var i=t.data,n=(t.code,t.msg),s=i.screen;0==s.length&&e.$message({message:n,type:"error"});for(var a=i.session,r=0;r<s.length;r++){s[r].children=[];for(var c=0;c<a.length;c++)s[r]._id==a[c].screen_id&&(a[c]._start_time=parseInt((Object(h["c"])(a[c].start_datetime)/1e3-e.initConfig.startPointStamp)/60),a[c]._isSetShow=!1,s[r].children.push(a[c]))}e.saveFilm=a,e.screenList=s,e.listLoading=!1});case 2:case"end":return t.stop()}},t,this)}));function e(){return t.apply(this,arguments)}return e}(),drapMove:function(t){if(this.isAdd){var e=t.pageX,i=t.pageY,n=this.$refs.screenbox,s=this.$refs.drag,a=this.$refs.lines[0],r=n.offsetHeight,c=162*this.effectiveTimeLong.length,o=this.getPos(n),l=o.top,d=(o.left,this.getPos(a).left);if(e<d||e>d+c||i<=l||i>=l+r)this.filmPos={pointXCenter:-9999,pointYCenter:0};else{var m=e-d,f=i-l,u=null;u=m-s.offsetWidth/2;u<=0&&(u=0),u>=60*this.effectiveTimeLong.length-this.dragFilm.film_long&&(u=60*this.effectiveTimeLong.length-this.dragFilm.film_long),this.filmPos.pointXCenter=u+170;var g=this.initConfig.startPointStamp+60*u;this.dragFilm.start_time=Object(h["b"])(g,"hm"),this.dragFilm.end_time=Object(h["b"])(60*this.dragFilm.film_long+g,"hm"),this.dragFilm._start_time=parseInt(u);var _=parseInt(f/81),v=81*_;this.screenList[_]&&(this.dragFilm.screen_id=this.screenList[_]._id,this.dragFilm.screen_name=this.screenList[_].screen_name),this.filmPos.pointYCenter=v,this.dragFilm._t=v}}},handleSelect:function(t){this.searchInfo.language="",this.searchInfo.film_version="",this.searchInfo.languageArr=t.language.split("/"),this.searchInfo.film_versionArr=t.film_version.split("/"),this.dragFilm=t,this.dragFilm.film_id=t._id,delete this.dragFilm._id,delete this.dragFilm.__v},querySearchAsync:function(t,e){""!=t&&o({film_name:t}).then(function(t){var i=t.data;i.forEach(function(t){t.value=t.film_name}),e(i)})},addFilm:function(){this.dragFilm.language=this.searchInfo.language,this.dragFilm.film_version=this.searchInfo.film_version,this.dragFilm.sell_price=this.searchInfo.sell_price,this.isAdd?(this.$message({message:"影片已取消",type:"success"}),this.isAdd=!1):(this.$message({message:"影片已添加，请将鼠标拖动至时间轴",type:"success"}),this.isAdd=!0)},downFilm:function(){var t=this;if(0==this.filmRepeat(this.saveFilm,Object(a["a"])({},this.dragFilm))){var e=Object(a["a"])({},this.dragFilm);e.cinema_id=this.cinema_id,e.status=0,e.start_datetime="".concat(Object(h["b"])(this.nowDate,"YMD")," ").concat(e.start_time),e.end_datetime="".concat(Object(h["b"])(this.nowDate,"YMD")," ").concat(e.end_time),this.saveFilm._isSetShow=!1,this.saveFilm.push(e),l(e).then(function(i){var n=i.data,s=Object(a["a"])({},e,n);t.screenList.forEach(function(t){t._id==s.screen_id&&t.children.push(s)})})}},filmRepeat:function(t,e){var i=0;return t.forEach(function(t){var n=1*t._start_time,s=n+t.film_long,a=1*e._start_time,r=a+t.film_long;t.screen_id==e.screen_id&&(a>=n&&a<=s||r>=n&&r<=s)&&i++}),i},setRightClick:function(t,e,i){t.preventDefault();var n=this.screenList[e].children[i];n._isSetShow=!n._isSetShow},delPlan:function(t,e){var i=this;this.$confirm("群定要删除该排期吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){m({_id:e}).then(function(n){i.$message({message:n.msg,type:"success"}),i.saveFilm.forEach(function(t,n){t._id==e&&i.saveFilm.splice(n,1)}),i.screenList.forEach(function(i){i._id==t&&i.children.forEach(function(t,n){t._id==e&&i.children.splice(n,1)})})})})},agree:function(){var t=this;if(0!=this.agreeFilm.length){var e=this.agreeFilm.map(function(t){return t._id});f(e).then(function(e){t.$message({message:e.msg,type:"success"}),t.agreeFilm=[],t.getScreenList()})}else this.$message({message:"请先选择影片",type:"error"})},tapSelect:function(t,e,i){if(0==i){var n=Object(h["a"])(this.agreeFilm,"_id",{screen_id:t,_id:e}),s=document.querySelectorAll(".drag-film");if(n)for(var a=0;a<s.length;a++)s[a].getAttribute("id")==n[0]._id&&(s[a].className=s[a].className.replace(/\sbd/g,""));else{this.agreeFilm.push({screen_id:t,_id:e});for(var r=0;r<s.length;r++)s[r].getAttribute("id")==e&&(s[r].className=s[r].className+" bd")}}},getSelectData:function(t){this.initConfig.startPointStamp=Object(h["c"])("".concat(Object(h["b"])(this.nowDate,"YMD")," ").concat(this.initConfig.startPoint,":0:0"))/1e3,this.getScreenList()},getPos:function(t){var e=0,i=0;while(t)e+=t.offsetTop,i+=t.offsetLeft,t=t.offsetParent;return{left:i,top:e}}},filters:{getHm:function(t){return Object(h["b"])(t,"hm")}}},_=g,v=(i("0d8d"),i("17cc")),p=Object(v["a"])(_,n,s,!1,null,null,null);e["default"]=p.exports},a3ba:function(t,e,i){"use strict";var n=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("el-button",{attrs:{size:"medium"},on:{click:t.goBack}},[t._v("返回")])},s=[],a={data:function(){return{}},methods:{goBack:function(){this.$router.go(-1)}}},r=a,c=i("17cc"),o=Object(c["a"])(r,n,s,!1,null,"6d81d39c",null);e["a"]=o.exports},ed08:function(t,e,i){"use strict";i.d(e,"b",function(){return s}),i.d(e,"c",function(){return a}),i.d(e,"a",function(){return r});i("f763"),i("3b54"),i("df36"),i("7bc1"),i("34a3"),i("0857"),i("3d92");function n(t){return 1*t<10?"0"+t:t}var s=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"YMDhms",i=null;console.log(t),i="[object Date]"==Object.prototype.toString.call(t)?t:t/1e10<1?1e3*t:t;var s=new Date(i),a=s.getFullYear(),r=n(s.getMonth()+1),c=n(s.getDate()),o=n(s.getHours()),l=n(s.getMinutes()),d=n(s.getSeconds()),m=new Map([["Y",a],["M",r],["D",c],["h",o],["hm","".concat(o,":").concat(l)],["hms","".concat(o,":").concat(l,":").concat(d)],["YM","".concat(a,"-").concat(r)],["YMD","".concat(a,"-").concat(r,"-").concat(c)],["YMDhms","".concat(a,"-").concat(r,"-").concat(c," ").concat(o,":").concat(l,":").concat(d)],["YMDhm","".concat(a,"-").concat(r,"-").concat(c," ").concat(o,":").concat(l)]]);return m.get(e)},a=function(t){var e=t.replace(/-/g,"/");return new Date(e).getTime()},r=function(t,e,i){var n=i[e]?i[e]:i,s="";return t.forEach(function(i,a){i[e]==n&&(s=t.splice(a,1))}),s}}}]);